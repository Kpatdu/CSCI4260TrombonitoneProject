<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trumbonitone</title>

    <!-- These imports are all essential for MIDI! -->
    <!-- polyfill -->
    <script src="./inc/shim/Base64.js" type="text/javascript"></script>
    <script src="./inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="./inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="./js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="./js/midi/gm.js" type="text/javascript"></script>
    <script src="./js/midi/loader.js" type="text/javascript"></script>
    <script src="./js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="./js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="./js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="./js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="./js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
</body>
<script>
    window.onload = function () {
        MIDI.loadPlugin({
            soundfontUrl: "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/",
            instruments: ["trumpet"],
            onsuccess: function () {
                MIDI.programChange(0, MIDI.GM.byName["trumpet"].number);
                midiReady = true;
            }
        });
    };

    function playNote() {
        /* For note to MIDI conversion, see here: https://newt.phys.unsw.edu.au/jw/notes.html */

        if (!midiReady) {
            console.warn("MIDI not ready yet!");
            return;
        }

        const channel = 0;
        const velocity = 127;
        const delay = 0;
        lastNote = note;
        if (isNone()) note = 60;     // Plays C key. Spacebar is just ' '.
        else if (isJ()) note = 65;   // Plays F key
        else if (isJK()) note = 64;  // Plays E key
        else if (isJL()) note = 62;
        else if (isK()) note = 71;
        else if (isKL()) note = 80;  // No idea what this plays.
        else if (isJKL()) note = 66;

        if (keysPressed[' ']) {
            MIDI.noteOff(channel, lastNote, velocity, delay);
            MIDI.noteOn(channel, note, velocity, delay);
        }
        else {
            MIDI.noteOff(channel, note, delay);
        }
    }

    let midiReady = false;
    let note = 0;
    let lastNote = 0;

    const keysPressed = {};

    const img_strt = new Image();
    img_strt.src = './Trumpet.png';
    img_strt.style.display = 'block';
    const img_j = new Image();
    img_j.src = './Trumpet_J.png';
    img_j.style.display = 'none';
    const img_k = new Image();
    img_k.src = './Trumpet_K.png';
    img_k.style.display = 'none';
    const img_l = new Image();
    img_l.src = './Trumpet_L.png';
    img_l.style.display = 'none';
    const img_jk = new Image();
    img_jk.src = './Trumpet_KJ.png';
    img_jk.style.display = 'none';
    const img_jl = new Image();
    img_jl.src = './Trumpet_LJ.png';
    img_jl.style.display = 'none';
    const img_kl = new Image();
    img_kl.src = './Trumpet_KL.png';
    img_kl.style.display = 'none';
    const img_jkl = new Image();
    img_jkl.src = './Trumpet_JKL.png';
    img_jkl.style.display = 'none';

    img_strt.onload = () => document.body.appendChild(img_strt);
    img_j.onload = () => document.body.appendChild(img_j);
    img_k.onload = () => document.body.appendChild(img_k);
    img_l.onload = () => document.body.appendChild(img_l);
    img_jk.onload = () => document.body.appendChild(img_jk);
    img_jl.onload = () => document.body.appendChild(img_jl);
    img_kl.onload = () => document.body.appendChild(img_kl);
    img_jkl.onload = () => document.body.appendChild(img_jkl);

    document.addEventListener('keydown', (e) => {
        keysPressed[e.key.toLowerCase()] = true;
        playNote();
    });

    document.addEventListener('keyup', (e) => {
        keysPressed[e.key.toLowerCase()] = false;
        playNote();
    });

    function updateDisplay() {
        if (isNone()) {
            img_strt.style.display = 'block';
            img_j.style.display = 'none';
            img_k.style.display = 'none';
            img_l.style.display = 'none';
            img_jk.style.display = 'none';
            img_jl.style.display = 'none';
            img_kl.style.display = 'none';
            img_jkl.style.display = 'none';
        } else if (isJ()) {
            img_strt.style.display = 'none';
            img_j.style.display = 'block';
            img_k.style.display = 'none';
            img_l.style.display = 'none';
            img_jk.style.display = 'none';
            img_jl.style.display = 'none';
            img_kl.style.display = 'none';
            img_jkl.style.display = 'none';
        } else if (isK()) {
            img_strt.style.display = 'none';
            img_j.style.display = 'none';
            img_k.style.display = 'block';
            img_l.style.display = 'none';
            img_jk.style.display = 'none';
            img_jl.style.display = 'none';
            img_kl.style.display = 'none';
            img_jkl.style.display = 'none';
        } else if (isL()) {
            img_strt.style.display = 'none';
            img_j.style.display = 'none';
            img_k.style.display = 'none';
            img_l.style.display = 'block';
            img_jk.style.display = 'none';
            img_jl.style.display = 'none';
            img_kl.style.display = 'none';
            img_jkl.style.display = 'none';
        } else if (isJK()) {
            img_strt.style.display = 'none';
            img_j.style.display = 'none';
            img_k.style.display = 'none';
            img_l.style.display = 'none';
            img_jk.style.display = 'block';
            img_jl.style.display = 'none';
            img_kl.style.display = 'none';
            img_jkl.style.display = 'none';
        } else if (isJL()) {
            img_strt.style.display = 'none';
            img_j.style.display = 'none';
            img_k.style.display = 'none';
            img_l.style.display = 'none';
            img_jk.style.display = 'none';
            img_jl.style.display = 'block';
            img_kl.style.display = 'none';
            img_jkl.style.display = 'none';
        } else if (isKL()) {
            img_strt.style.display = 'none';
            img_j.style.display = 'none';
            img_k.style.display = 'none';
            img_l.style.display = 'none';
            img_jk.style.display = 'none';
            img_jl.style.display = 'none';
            img_kl.style.display = 'block';
            img_jkl.style.display = 'none';
        } else if (isJKL()) {
            img_strt.style.display = 'none';
            img_j.style.display = 'none';
            img_k.style.display = 'none';
            img_l.style.display = 'none';
            img_jk.style.display = 'none';
            img_jl.style.display = 'none';
            img_kl.style.display = 'none';
            img_jkl.style.display = 'block';
        }

        requestAnimationFrame(updateDisplay);
    }

    requestAnimationFrame(updateDisplay);

    function isNone() {
        // FIXME: This will need to omit space key from being pressed.
        return Object.values(keysPressed).every(value => value === false);
    }

    function isJ() {
        return (keysPressed['j'] && !keysPressed['k'] && !keysPressed['l']);
    }

    function isK() {
        return (!keysPressed['j'] && keysPressed['k'] && !keysPressed['l']);
    }

    function isL() {
        return (!keysPressed['j'] && !keysPressed['k'] && keysPressed['l']);
    }

    function isJK() {
        return (keysPressed['j'] && keysPressed['k'] && !keysPressed['l']);
    }

    function isJL() {
        return (keysPressed['j'] && !keysPressed['k'] && keysPressed['l']);
    }

    function isKL() {
        return (!keysPressed['j'] && keysPressed['k'] && keysPressed['l']);
    }

    function isJKL() {
        return (keysPressed['j'] && keysPressed['k'] && keysPressed['l']);
    }
</script>
</html>